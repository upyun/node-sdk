/**
  * UPYUN js-sdk 3.0.0
  * (c) 2017
  * @license MIT
  */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Upyun=t()}(this,function(){"use strict";function e(e){return"[object Array]"===_.call(e)}function t(e){return"undefined"!=typeof Buffer&&Buffer.isBuffer&&Buffer.isBuffer(e)}function r(e){return"[object ArrayBuffer]"===_.call(e)}function n(e){return"undefined"!=typeof FormData&&e instanceof FormData}function o(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer}function a(e){return"string"==typeof e}function u(e){return"number"==typeof e}function i(e){return void 0===e}function s(e){return null!==e&&"object"==typeof e}function c(e){return"[object Date]"===_.call(e)}function f(e){return"[object File]"===_.call(e)}function p(e){return"[object Blob]"===_.call(e)}function l(e){return"[object Function]"===_.call(e)}function d(e){return s(e)&&l(e.pipe)}function h(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams}function m(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")}function y(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)}function g(t,r){if(null!==t&&void 0!==t)if("object"==typeof t||e(t)||(t=[t]),e(t))for(var n=0,o=t.length;n<o;n++)r.call(null,t[n],n,t);else for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&r.call(null,t[a],a,t)}function v(){function e(e,r){"object"==typeof t[r]&&"object"==typeof e?t[r]=v(t[r],e):t[r]=e}for(var t={},r=0,n=arguments.length;r<n;r++)g(arguments[r],e);return t}function b(e,t,r){return g(t,function(t,n){e[n]=r&&"function"==typeof t?z(t,r):t}),e}function w(e){return encodeURIComponent(e).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function x(){this.message="String contains an invalid character"}function k(e){for(var t,r,n=String(e),o="",a=0,u=Y;n.charAt(0|a)||(u="=",a%1);o+=u.charAt(63&t>>8-a%1*8)){if((r=n.charCodeAt(a+=.75))>255)throw new x;t=t<<8|r}return o}function R(e,t){!M.isUndefined(e)&&M.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}function A(){this.handlers=[]}function S(e){e.cancelToken&&e.cancelToken.throwIfRequested()}function C(e){this.defaults=e,this.interceptors={request:new oe,response:new oe}}function E(e){this.message=e}function j(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise(function(e){t=e});var r=this;e(function(e){r.reason||(r.reason=new pe(e),t(r.reason))})}function T(e){var t=new fe(e),r=z(fe.prototype.request,t);return M.extend(r,fe.prototype,t),M.extend(r,t),r}function B(e,t,r){return new Promise(function(n,o){var a=e.slice||e.mozSlice||e.webkitSlice;return a?n(a.call(e,t,r)):o(new Error("not support File type!"))})}function N(e,t,r,n){function o(e,t,r,n){return e<20?t&r|~t&n:e<40?t^r^n:e<60?t&r|t&n|r&n:t^r^n}function a(e){return e<20?1518500249:e<40?1859775393:e<60?-1894007588:-899497514}function u(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function i(e,t){return e<<t|e>>>32-t}function s(e,t){e[t>>5]|=128<<24-t%32,e[15+(t+64>>9<<4)]=t;for(var r=[80],n=1732584193,s=-271733879,c=-1732584194,f=271733878,p=-1009589776,l=0;l<e.length;l+=16){for(var d=n,h=s,m=c,y=f,g=p,v=0;v<80;v++){r[v]=v<16?e[l+v]:i(r[v-3]^r[v-8]^r[v-14]^r[v-16],1);var b=u(u(i(n,5),o(v,s,c,f)),u(u(p,r[v]),a(v)));p=f,f=c,c=i(s,30),s=n,n=b}n=u(n,d),s=u(s,h),c=u(c,m),f=u(f,y),p=u(p,g)}return[n,s,c,f,p]}function c(e){for(var t=[],r=(1<<n)-1,o=0;o<e.length*n;o+=n)t[o>>5]|=(e.charCodeAt(o/8)&r)<<32-n-o%32;return t}function f(e,t){var r=c(e);r.length>16&&(r=s(r,e.length*n));for(var o=[16],a=[16],u=0;u<16;u++)o[u]=909522486^r[u],a[u]=1549556828^r[u];var i=s(o.concat(c(t)),512+t.length*n);return s(a.concat(i),672)}function p(e){for(var t="",n=0;n<4*e.length;n+=3)for(var o=(e[n>>2]>>8*(3-n%4)&255)<<16|(e[n+1>>2]>>8*(3-(n+1)%4)&255)<<8|e[n+2>>2]>>8*(3-(n+2)%4)&255,a=0;a<4;a++)8*n+6*a>32*e.length?t+=r:t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(o>>6*(3-a)&63);return t}return r||(r="="),n||(n=8),function(e,t){return p(f(e,t))}(e,t)}function U(e,t){return t={exports:{}},e(t,t.exports),t.exports}function q(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=(new Date).toGMTString();return{Authorization:O(e,{method:t,path:r="/"+e.bucketName+r,date:o,contentMd5:n}),"X-Date":o,"User-Agent":"Js-Sdk/"+je.version}}function O(e,t){var r=[t.method,t.path];["date","policy","contentMd5"].forEach(function(e){t[e]&&r.push(t[e])});var n=Se(e.password,r.join("&"));return"UPYUN "+e.operatorName+":"+n}function P(e,t){if(t.bucket=e.bucketName,void 0===t["save-key"])throw new Error("upyun - calclate body sign need save-key");void 0===t.expiration&&(t.expiration=parseInt(new Date/1e3+1800,10));var r=Ee.encode(JSON.stringify(t));return{policy:r,authorization:O(e,{method:"POST",path:"/"+e.bucketName,policy:r})}}function D(e){return 0===e.indexOf("x-upyun-meta-")}function L(e,t,r){var n=Te.getHeaderSign(e,t,r);return Promise.resolve(n)}function F(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}function I(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&F(e.slice(0,0))}var z=function(e,t){return function(){for(var r=new Array(arguments.length),n=0;n<r.length;n++)r[n]=arguments[n];return e.apply(t,r)}},_=Object.prototype.toString,M={isArray:e,isArrayBuffer:r,isBuffer:t,isFormData:n,isArrayBufferView:o,isString:a,isNumber:u,isObject:s,isUndefined:i,isDate:c,isFile:f,isBlob:p,isFunction:l,isStream:d,isURLSearchParams:h,isStandardBrowserEnv:y,forEach:g,merge:v,extend:b,trim:m},H=function(e,t){M.forEach(e,function(r,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=r,delete e[n])})},X=function(e,t,r,n){return e.config=t,r&&(e.code=r),e.response=n,e},J=function(e,t,r,n){var o=new Error(e);return X(o,t,r,n)},G=function(e,t,r){var n=r.config.validateStatus;r.status&&n&&!n(r.status)?t(J("Request failed with status code "+r.status,r.config,null,r)):e(r)},V=function(e,t,r){if(!t)return e;var n;if(r)n=r(t);else if(M.isURLSearchParams(t))n=t.toString();else{var o=[];M.forEach(t,function(e,t){null!==e&&void 0!==e&&(M.isArray(e)&&(t+="[]"),M.isArray(e)||(e=[e]),M.forEach(e,function(e){M.isDate(e)?e=e.toISOString():M.isObject(e)&&(e=JSON.stringify(e)),o.push(w(t)+"="+w(e))}))}),n=o.join("&")}return n&&(e+=(-1===e.indexOf("?")?"?":"&")+n),e},K=function(e){var t,r,n,o={};return e?(M.forEach(e.split("\n"),function(e){n=e.indexOf(":"),t=M.trim(e.substr(0,n)).toLowerCase(),r=M.trim(e.substr(n+1)),t&&(o[t]=o[t]?o[t]+", "+r:r)}),o):o},W=M.isStandardBrowserEnv()?function(){function e(e){var t=e;return r&&(n.setAttribute("href",t),t=n.href),n.setAttribute("href",t),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:"/"===n.pathname.charAt(0)?n.pathname:"/"+n.pathname}}var t,r=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");return t=e(window.location.href),function(r){var n=M.isString(r)?e(r):r;return n.protocol===t.protocol&&n.host===t.host}}():function(){return function(){return!0}}(),Y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";x.prototype=new Error,x.prototype.code=5,x.prototype.name="InvalidCharacterError";var Z=k,$=M.isStandardBrowserEnv()?function(){return{write:function(e,t,r,n,o,a){var u=[];u.push(e+"="+encodeURIComponent(t)),M.isNumber(r)&&u.push("expires="+new Date(r).toGMTString()),M.isString(n)&&u.push("path="+n),M.isString(o)&&u.push("domain="+o),!0===a&&u.push("secure"),document.cookie=u.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}}():function(){return{write:function(){},read:function(){return null},remove:function(){}}}(),Q="undefined"!=typeof window&&window.btoa&&window.btoa.bind(window)||Z,ee=function(e){return new Promise(function(t,r){var n=e.data,o=e.headers;M.isFormData(n)&&delete o["Content-Type"];var a=new XMLHttpRequest,u="onreadystatechange",i=!1;if("undefined"==typeof window||!window.XDomainRequest||"withCredentials"in a||W(e.url)||(a=new window.XDomainRequest,u="onload",i=!0,a.onprogress=function(){},a.ontimeout=function(){}),e.auth){var s=e.auth.username||"",c=e.auth.password||"";o.Authorization="Basic "+Q(s+":"+c)}if(a.open(e.method.toUpperCase(),V(e.url,e.params,e.paramsSerializer),!0),a.timeout=e.timeout,a[u]=function(){if(a&&(4===a.readyState||i)&&(0!==a.status||a.responseURL&&0===a.responseURL.indexOf("file:"))){var n="getAllResponseHeaders"in a?K(a.getAllResponseHeaders()):null,o={data:e.responseType&&"text"!==e.responseType?a.response:a.responseText,status:1223===a.status?204:a.status,statusText:1223===a.status?"No Content":a.statusText,headers:n,config:e,request:a};G(t,r,o),a=null}},a.onerror=function(){r(J("Network Error",e)),a=null},a.ontimeout=function(){r(J("timeout of "+e.timeout+"ms exceeded",e,"ECONNABORTED")),a=null},M.isStandardBrowserEnv()){var f=$,p=(e.withCredentials||W(e.url))&&e.xsrfCookieName?f.read(e.xsrfCookieName):void 0;p&&(o[e.xsrfHeaderName]=p)}if("setRequestHeader"in a&&M.forEach(o,function(e,t){void 0===n&&"content-type"===t.toLowerCase()?delete o[t]:a.setRequestHeader(t,e)}),e.withCredentials&&(a.withCredentials=!0),e.responseType)try{a.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&a.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&a.upload&&a.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then(function(e){a&&(a.abort(),r(e),a=null)}),void 0===n&&(n=null),a.send(n)})},te={"Content-Type":"application/x-www-form-urlencoded"},re={adapter:function(){var e;return"undefined"!=typeof XMLHttpRequest?e=ee:"undefined"!=typeof process&&(e=ee),e}(),transformRequest:[function(e,t){return H(t,"Content-Type"),M.isFormData(e)||M.isArrayBuffer(e)||M.isBuffer(e)||M.isStream(e)||M.isFile(e)||M.isBlob(e)?e:M.isArrayBufferView(e)?e.buffer:M.isURLSearchParams(e)?(R(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):M.isObject(e)?(R(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function(e){return e>=200&&e<300}};re.headers={common:{Accept:"application/json, text/plain, */*"}},M.forEach(["delete","get","head"],function(e){re.headers[e]={}}),M.forEach(["post","put","patch"],function(e){re.headers[e]=M.merge(te)});var ne=re;A.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},A.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},A.prototype.forEach=function(e){M.forEach(this.handlers,function(t){null!==t&&e(t)})};var oe=A,ae=function(e,t,r){return M.forEach(r,function(r){e=r(e,t)}),e},ue=function(e){return!(!e||!e.__CANCEL__)},ie=function(e){return S(e),e.headers=e.headers||{},e.data=ae(e.data,e.headers,e.transformRequest),e.headers=M.merge(e.headers.common||{},e.headers[e.method]||{},e.headers||{}),M.forEach(["delete","get","head","post","put","patch","common"],function(t){delete e.headers[t]}),(e.adapter||ne.adapter)(e).then(function(t){return S(e),t.data=ae(t.data,t.headers,e.transformResponse),t},function(t){return ue(t)||(S(e),t&&t.response&&(t.response.data=ae(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)})},se=function(e){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(e)},ce=function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e};C.prototype.request=function(e){"string"==typeof e&&(e=M.merge({url:arguments[0]},arguments[1])),(e=M.merge(ne,this.defaults,{method:"get"},e)).baseURL&&!se(e.url)&&(e.url=ce(e.baseURL,e.url));var t=[ie,void 0],r=Promise.resolve(e);for(this.interceptors.request.forEach(function(e){t.unshift(e.fulfilled,e.rejected)}),this.interceptors.response.forEach(function(e){t.push(e.fulfilled,e.rejected)});t.length;)r=r.then(t.shift(),t.shift());return r},M.forEach(["delete","get","head","options"],function(e){C.prototype[e]=function(t,r){return this.request(M.merge(r||{},{method:e,url:t}))}}),M.forEach(["post","put","patch"],function(e){C.prototype[e]=function(t,r,n){return this.request(M.merge(n||{},{method:e,url:t,data:r}))}});var fe=C;E.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},E.prototype.__CANCEL__=!0;var pe=E;j.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},j.source=function(){var e;return{token:new j(function(t){e=t}),cancel:e}};var le=j,de=function(e){return function(t){return e.apply(null,t)}},he=T(ne);he.Axios=fe,he.create=function(e){return T(M.merge(ne,e))},he.Cancel=pe,he.CancelToken=le,he.isCancel=ue,he.all=function(e){return Promise.all(e)},he.spread=de;var me=he,ye=he;me.default=ye;var ge=me,ve=function(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){function n(o,a){try{var u=t[o](a),i=u.value}catch(e){return void r(e)}if(!u.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});e(i)}return n("next")})}},be=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},we=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),xe=function(){function e(e,t){var r=[],n=!0,o=!1,a=void 0;try{for(var u,i=e[Symbol.iterator]();!(n=(u=i.next()).done)&&(r.push(u.value),!t||r.length!==t);n=!0);}catch(e){o=!0,a=e}finally{try{!n&&i.return&&i.return()}finally{if(o)throw a}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),ke=function(e,t,r){var n=this,o=ge.create({baseURL:e+"/"+t.bucketName});return o.interceptors.request.use(function(){var e=ve(regeneratorRuntime.mark(function e(o){var a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=o.method.toUpperCase(),u=o.url.substring(o.baseURL.length),e.next=4,r(t,a,u);case 4:return o.headers.common=e.sent,e.abrupt("return",o);case 6:case"end":return e.stop()}},e,n)}));return function(t){return e.apply(this,arguments)}}(),function(e){throw new Error("upyun - request failed: "+e.message)}),o.interceptors.response.use(function(e){return e},function(e){var t=e.response;if(void 0===t)throw e;if(404!==t.status)throw new Error("upyun - response error: "+t.data.code+" "+t.data.msg);return t}),o},Re={readBlockAsync:B},Ae=function(){function e(e,r,n){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t,r,n){var o,a,u,i=n.authorization,s=n.policy;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return(o=new FormData).append("authorization",i),o.append("policy",s),o.append("file",r),e.next=6,ge.post(t,o);case 6:return a=e.sent,u=a.status,e.abrupt("return",200===u);case 9:case"end":return e.stop()}},e,this)}));return e}(),Se=N,Ce="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Ee=U(function(e,t){!function(r){var n=t,o=e&&e.exports==n&&e,a="object"==typeof Ce&&Ce;a.global!==a&&a.window!==a||(r=a);var u=function(e){this.message=e};(u.prototype=new Error).name="InvalidCharacterError";var i=function(e){throw new u(e)},s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=/[\t\n\f\r ]/g,f={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&i("The string to be encoded contains characters outside of the Latin1 range.");for(var t,r=e.length%3,n="",o=-1,a=e.length-r;++o<a;)t=(e.charCodeAt(o)<<16)+(e.charCodeAt(++o)<<8)+e.charCodeAt(++o),n+=s.charAt(t>>18&63)+s.charAt(t>>12&63)+s.charAt(t>>6&63)+s.charAt(63&t);return 2==r?(t=(e.charCodeAt(o)<<8)+e.charCodeAt(++o),n+=s.charAt(t>>10)+s.charAt(t>>4&63)+s.charAt(t<<2&63)+"="):1==r&&(t=e.charCodeAt(o),n+=s.charAt(t>>2)+s.charAt(t<<4&63)+"=="),n},decode:function(e){var t=(e=String(e).replace(c,"")).length;t%4==0&&(t=(e=e.replace(/==?$/,"")).length),(t%4==1||/[^+a-zA-Z0-9/]/.test(e))&&i("Invalid character: the string to be decoded is not correctly encoded.");for(var r,n,o=0,a="",u=-1;++u<t;)n=s.indexOf(e.charAt(u)),r=o%4?64*r+n:n,o++%4&&(a+=String.fromCharCode(255&r>>(-2*o&6)));return a},version:"0.1.0"};if(n&&!n.nodeType)if(o)o.exports=f;else for(var p in f)f.hasOwnProperty(p)&&(n[p]=f[p]);else r.base64=f}(Ce)}),je={name:"upyun",version:"3.0.0",description:"UPYUN js sdk",main:"dist/upyun.common.js",unpkg:"dist/upyun.js",scripts:{build:"node build/build.js",test:"npm run test:server && npm run test:client","test:client":"./node_modules/.bin/karma start tests/karma.conf.js","test:server":"./node_modules/.bin/mocha --compilers js:babel-register tests/server/*"},repository:{type:"git",url:"git@github.com:upyun/node-sdk.git"},keywords:["upyun","js","nodejs","sdk","cdn","cloud","storage"],author:"Leigh",license:"MIT",bugs:{url:"https://github.com/upyun/node-sdk/issues"},homepage:"https://github.com/upyun/node-sdk",contributors:[{name:"yejingx",email:"yejingx@gmail.com"},{name:"Leigh",email:"i@zhuli.me"},{name:"kaidiren",email:"kaidiren@gmail.com"},{name:"Gaara",email:"sabakugaara@users.noreply.github.com"}],devDependencies:{"babel-cli":"^6.24.1","babel-loader":"^7.0.0","babel-plugin-external-helpers":"^6.22.0","babel-plugin-transform-runtime":"^6.23.0","babel-preset-env":"^1.4.0","babel-register":"^6.24.1",chai:"^3.5.0",istanbul:"^0.4.3",karma:"^1.7.0","karma-chrome-launcher":"^2.1.1","karma-mocha":"^1.3.0","karma-sourcemap-loader":"^0.3.7","karma-webpack":"^2.0.3",mocha:"^3.4.1",rollup:"^0.41.6","rollup-plugin-alias":"^1.3.1","rollup-plugin-babel":"^2.7.1","rollup-plugin-commonjs":"^8.0.2","rollup-plugin-json":"^2.1.1","rollup-plugin-node-resolve":"^3.0.0","rollup-plugin-replace":"^1.1.1",should:"^9.0.2","uglify-js":"^3.0.11",webpack:"^2.5.1"},dependencies:{axios:"^0.16.1","base-64":"^0.1.0","form-data":"^2.1.4",hmacsha1:"^1.0.0",md5:"^2.2.1","mime-types":"^2.1.15"},browser:{"./upyun/utils.js":"./upyun/browser-utils.js","./upyun/form-upload.js":"./upyun/browser-form-upload.js"},peerDependencies:{"babel-polyfill":"^6.23.0"}},Te={genSign:O,getHeaderSign:q,getPolicyAndAuthorization:P},Be=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;be(this,e);var o="undefined"!=typeof window;if(void 0===t.bucketName)throw new Error("upyun - must config bucketName");if("function"==typeof r&&(n=r,r={}),"function"!=typeof n&&o)throw new Error("upyun - must config a callback function getHeaderSign in client side");if(!o&&(void 0===t.operatorName||void 0===t.password))throw new Error("upyun - must config operateName and password in server side");this.isBrowser=o;var a=Object.assign({domain:"v0.api.upyun.com",protocol:"https"},r);this.endpoint=a.protocol+"://"+a.domain,this.req=ke(this.endpoint,t,n||L),this.bucket=t,o||this.setBodySignCallback(Te.getPolicyAndAuthorization)}return we(e,[{key:"setBucket",value:function(e){this.bucket=e,this.req.defaults.baseURL=this.endpoint+"/"+this.bucketName}},{key:"setBodySignCallback",value:function(e){if("function"!=typeof e)throw new Error("upyun - getBodySign should be a function");this.bodySignCallback=e}},{key:"usage",value:function(){function e(){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(){var t,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/";return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=encodeURI(n+"?usage"),e.next=3,this.req.get(n);case 3:return t=e.sent,r=t.data,e.abrupt("return",r);case 6:case"end":return e.stop()}},e,this)}));return e}()},{key:"listDir",value:function(){function e(){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(){var t,r,n,o,a,u,i,s,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"/",f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},p=f.limit,l=void 0===p?100:p,d=f.order,h=void 0===d?"asc":d,m=f.iter,y=void 0===m?"":m;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return c=encodeURI(c),t={"x-list-limit":l,"x-list-order":h},y&&(t["x-list-iter"]=y),e.next=5,this.req.get(c,{headers:t});case 5:if(r=e.sent,n=r.data,o=r.headers,404!==(a=r.status)){e.next=11;break}return e.abrupt("return",!1);case 11:if(u=o["x-upyun-list-iter"],n){e.next=14;break}return e.abrupt("return",{files:[],next:u});case 14:return i=n.split("\n"),s=i.map(function(e){var t=e.split("\t"),r=xe(t,4),n=r[0],o=r[1],a=r[2],u=r[3];return{name:n,type:o,size:parseInt(a),time:parseInt(u)}}),e.abrupt("return",{files:s,next:u});case 17:case"end":return e.stop()}},e,this)}));return e}()},{key:"putFile",value:function(){function e(e,r){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t,r){var n,o,a,u,i,s,c,f,p=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=encodeURI(t),o=["Content-MD5","Content-Length","Content-Type","Content-Secret","x-gmkerl-thumb"],a={},o.forEach(function(e){p[e]?a[e]=p[e]:D(e)&&(a[e]=p[e])}),e.next=6,this.req.put(n,r,{headers:a});case 6:if(u=e.sent,i=u.headers,200!==(s=u.status)){e.next=16;break}return c=["x-upyun-width","x-upyun-height","x-upyun-file-type","x-upyun-frames"],f={},c.forEach(function(e){var t=e.split("x-upyun-")[1];i[e]&&(f[t]=i[e],"file-type"!==t&&(f[t]=parseInt(f[t],10)))}),e.abrupt("return",!(Object.keys(f).length>0)||f);case 16:return e.abrupt("return",!1);case 17:case"end":return e.stop()}},e,this)}));return e}()},{key:"makeDir",value:function(){function e(e){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.req.post(t,null,{headers:{folder:"true"}});case 2:return r=e.sent,n=r.status,e.abrupt("return",200===n);case 5:case"end":return e.stop()}},e,this)}));return e}()},{key:"headFile",value:function(){function e(e){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t){var r,n,o,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.req.head(t);case 2:if(r=e.sent,n=r.headers,404!==(o=r.status)){e.next=7;break}return e.abrupt("return",!1);case 7:return a=["x-upyun-file-type","x-upyun-file-size","x-upyun-file-date","Content-Md5"],u={},a.forEach(function(e){var t=e.split("x-upyun-file-")[1];n[e]&&(u[t]=n[e],"size"!==t&&"date"!==t||(u[t]=parseInt(u[t],10)))}),e.abrupt("return",u);case 11:case"end":return e.stop()}},e,this)}));return e}()},{key:"deleteFile",value:function(){function e(e){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t){var r,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.req.delete(t);case 2:return r=e.sent,n=r.status,e.abrupt("return",200===n);case 5:case"end":return e.stop()}},e,this)}));return e}()},{key:"deleteDir",value:function(){function e(e){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.deleteFile(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}},e,this)}));return e}()},{key:"getFile",value:function(){function e(e){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t){var r,n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!o||"undefined"==typeof window){e.next=2;break}throw new Error("upyun - save as stream are only available on the server side.");case 2:return e.next=4,this.req({method:"GET",url:t,responseType:o?"stream":null});case 4:if(404!==(r=e.sent).status){e.next=7;break}return e.abrupt("return",!1);case 7:if(o){e.next=9;break}return e.abrupt("return",r.data);case 9:return n=r.data.pipe(o),e.abrupt("return",new Promise(function(e,t){n.on("finish",function(){return e(n)}),n.on("error",t)}));case 11:case"end":return e.stop()}},e,this)}));return e}()},{key:"updateMetadata",value:function(){function e(e,r){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t,r){var n,o,a,u,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"merge";return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:n={};for(o in r)D(o)?n[o]=r:n["x-upyun-meta-"+o]=r[o];return e.next=4,this.req.patch(t+"?metadata="+i,null,{headers:n});case 4:return a=e.sent,u=a.status,e.abrupt("return",200===u);case 7:case"end":return e.stop()}},e,this)}));return e}()},{key:"getMetadata",value:function(){function e(e){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t){var r,n,o,a,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.req.get(t);case 2:if(r=e.sent,n=r.headers,200===(o=r.status)){e.next=7;break}return e.abrupt("return",!1);case 7:a={};for(u in n)D(u)&&(a[u]=n[u]);return e.abrupt("return",a);case 10:case"end":return e.stop()}},e,this)}));return e}()},{key:"blockUpload",value:function(){function e(e,r){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t,r){var n,o,a,u,i,s,c,f,p,l,d,h,m,y,g,v=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n="undefined"!=typeof window,o=void 0,a=void 0,!n){e.next=8;break}o=r.size,a=r.type,e.next=12;break;case 8:return e.next=10,Re.getFileSizeAsync(r);case 10:o=e.sent,a=Re.getContentType(r);case 12:return Object.assign(v,{"x-upyun-multi-stage":"initiate","x-upyun-multi-length":o,"x-upyun-multi-type":a}),e.next=15,this.req.put(t,null,{headers:v});case 15:u=e.sent,i=u.headers,s=i["x-upyun-multi-uuid"],c=i["x-upyun-next-part-id"],f=void 0;case 20:return p=1048576,l=c*p,d=Math.min(l+p,o),e.next=25,Re.readBlockAsync(r,l,d);case 25:return f=e.sent,e.next=28,this.req.put(t,f,{headers:{"x-upyun-multi-stage":"upload","x-upyun-multi-uuid":s,"x-upyun-part-id":c}});case 28:h=e.sent,m=h.headers,c=m["x-upyun-next-part-id"];case 31:if("-1"!==c){e.next=20;break}case 32:return e.next=34,this.req.put(t,null,{headers:{"x-upyun-multi-stage":"complete","x-upyun-multi-uuid":s}});case 34:return y=e.sent,g=y.status,e.abrupt("return",204===g||201===g);case 37:case"end":return e.stop()}},e,this)}));return e}()},{key:"formPutFile",value:function(){function e(e,r){return t.apply(this,arguments)}var t=ve(regeneratorRuntime.mark(function e(t,r){var n,o,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if("function"==typeof this.bodySignCallback){e.next=2;break}throw new Error("upyun - must setBodySignCallback first!");case 2:return a.bucket=this.bucket.bucketName,a["save-key"]=t,e.next=6,this.bodySignCallback(this.bucket,a);case 6:return n=e.sent,e.next=9,Ae(this.endpoint+"/"+a.bucket,r,n);case 9:return o=e.sent,e.abrupt("return",o);case 11:case"end":return e.stop()}},e,this)}));return e}()}]),e}(),Ne=U(function(e){!function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r={rotl:function(e,t){return e<<t|e>>>32-t},rotr:function(e,t){return e<<32-t|e>>>t},endian:function(e){if(e.constructor==Number)return 16711935&r.rotl(e,8)|4278255360&r.rotl(e,24);for(var t=0;t<e.length;t++)e[t]=r.endian(e[t]);return e},randomBytes:function(e){for(var t=[];e>0;e--)t.push(Math.floor(256*Math.random()));return t},bytesToWords:function(e){for(var t=[],r=0,n=0;r<e.length;r++,n+=8)t[n>>>5]|=e[r]<<24-n%32;return t},wordsToBytes:function(e){for(var t=[],r=0;r<32*e.length;r+=8)t.push(e[r>>>5]>>>24-r%32&255);return t},bytesToHex:function(e){for(var t=[],r=0;r<e.length;r++)t.push((e[r]>>>4).toString(16)),t.push((15&e[r]).toString(16));return t.join("")},hexToBytes:function(e){for(var t=[],r=0;r<e.length;r+=2)t.push(parseInt(e.substr(r,2),16));return t},bytesToBase64:function(e){for(var r=[],n=0;n<e.length;n+=3)for(var o=e[n]<<16|e[n+1]<<8|e[n+2],a=0;a<4;a++)8*n+6*a<=8*e.length?r.push(t.charAt(o>>>6*(3-a)&63)):r.push("=");return r.join("")},base64ToBytes:function(e){e=e.replace(/[^A-Z0-9+\/]/gi,"");for(var r=[],n=0,o=0;n<e.length;o=++n%4)0!=o&&r.push((t.indexOf(e.charAt(n-1))&Math.pow(2,-2*o+8)-1)<<2*o|t.indexOf(e.charAt(n))>>>6-2*o);return r}};e.exports=r}()}),Ue={utf8:{stringToBytes:function(e){return Ue.bin.stringToBytes(unescape(encodeURIComponent(e)))},bytesToString:function(e){return decodeURIComponent(escape(Ue.bin.bytesToString(e)))}},bin:{stringToBytes:function(e){for(var t=[],r=0;r<e.length;r++)t.push(255&e.charCodeAt(r));return t},bytesToString:function(e){for(var t=[],r=0;r<e.length;r++)t.push(String.fromCharCode(e[r]));return t.join("")}}},qe=Ue,Oe=function(e){return null!=e&&(F(e)||I(e)||!!e._isBuffer)},Pe=U(function(e){!function(){var t=Ne,r=qe.utf8,n=Oe,o=qe.bin,a=function(e,u){e.constructor==String?e=u&&"binary"===u.encoding?o.stringToBytes(e):r.stringToBytes(e):n(e)?e=Array.prototype.slice.call(e,0):Array.isArray(e)||(e=e.toString());for(var i=t.bytesToWords(e),s=8*e.length,c=1732584193,f=-271733879,p=-1732584194,l=271733878,d=0;d<i.length;d++)i[d]=16711935&(i[d]<<8|i[d]>>>24)|4278255360&(i[d]<<24|i[d]>>>8);i[s>>>5]|=128<<s%32,i[14+(s+64>>>9<<4)]=s;for(var h=a._ff,m=a._gg,y=a._hh,g=a._ii,d=0;d<i.length;d+=16){var v=c,b=f,w=p,x=l;f=g(f=g(f=g(f=g(f=y(f=y(f=y(f=y(f=m(f=m(f=m(f=m(f=h(f=h(f=h(f=h(f,p=h(p,l=h(l,c=h(c,f,p,l,i[d+0],7,-680876936),f,p,i[d+1],12,-389564586),c,f,i[d+2],17,606105819),l,c,i[d+3],22,-1044525330),p=h(p,l=h(l,c=h(c,f,p,l,i[d+4],7,-176418897),f,p,i[d+5],12,1200080426),c,f,i[d+6],17,-1473231341),l,c,i[d+7],22,-45705983),p=h(p,l=h(l,c=h(c,f,p,l,i[d+8],7,1770035416),f,p,i[d+9],12,-1958414417),c,f,i[d+10],17,-42063),l,c,i[d+11],22,-1990404162),p=h(p,l=h(l,c=h(c,f,p,l,i[d+12],7,1804603682),f,p,i[d+13],12,-40341101),c,f,i[d+14],17,-1502002290),l,c,i[d+15],22,1236535329),p=m(p,l=m(l,c=m(c,f,p,l,i[d+1],5,-165796510),f,p,i[d+6],9,-1069501632),c,f,i[d+11],14,643717713),l,c,i[d+0],20,-373897302),p=m(p,l=m(l,c=m(c,f,p,l,i[d+5],5,-701558691),f,p,i[d+10],9,38016083),c,f,i[d+15],14,-660478335),l,c,i[d+4],20,-405537848),p=m(p,l=m(l,c=m(c,f,p,l,i[d+9],5,568446438),f,p,i[d+14],9,-1019803690),c,f,i[d+3],14,-187363961),l,c,i[d+8],20,1163531501),p=m(p,l=m(l,c=m(c,f,p,l,i[d+13],5,-1444681467),f,p,i[d+2],9,-51403784),c,f,i[d+7],14,1735328473),l,c,i[d+12],20,-1926607734),p=y(p,l=y(l,c=y(c,f,p,l,i[d+5],4,-378558),f,p,i[d+8],11,-2022574463),c,f,i[d+11],16,1839030562),l,c,i[d+14],23,-35309556),p=y(p,l=y(l,c=y(c,f,p,l,i[d+1],4,-1530992060),f,p,i[d+4],11,1272893353),c,f,i[d+7],16,-155497632),l,c,i[d+10],23,-1094730640),p=y(p,l=y(l,c=y(c,f,p,l,i[d+13],4,681279174),f,p,i[d+0],11,-358537222),c,f,i[d+3],16,-722521979),l,c,i[d+6],23,76029189),p=y(p,l=y(l,c=y(c,f,p,l,i[d+9],4,-640364487),f,p,i[d+12],11,-421815835),c,f,i[d+15],16,530742520),l,c,i[d+2],23,-995338651),p=g(p,l=g(l,c=g(c,f,p,l,i[d+0],6,-198630844),f,p,i[d+7],10,1126891415),c,f,i[d+14],15,-1416354905),l,c,i[d+5],21,-57434055),p=g(p,l=g(l,c=g(c,f,p,l,i[d+12],6,1700485571),f,p,i[d+3],10,-1894986606),c,f,i[d+10],15,-1051523),l,c,i[d+1],21,-2054922799),p=g(p,l=g(l,c=g(c,f,p,l,i[d+8],6,1873313359),f,p,i[d+15],10,-30611744),c,f,i[d+6],15,-1560198380),l,c,i[d+13],21,1309151649),p=g(p,l=g(l,c=g(c,f,p,l,i[d+4],6,-145523070),f,p,i[d+11],10,-1120210379),c,f,i[d+2],15,718787259),l,c,i[d+9],21,-343485551),c=c+v>>>0,f=f+b>>>0,p=p+w>>>0,l=l+x>>>0}return t.endian([c,f,p,l])};a._ff=function(e,t,r,n,o,a,u){var i=e+(t&r|~t&n)+(o>>>0)+u;return(i<<a|i>>>32-a)+t},a._gg=function(e,t,r,n,o,a,u){var i=e+(t&n|r&~n)+(o>>>0)+u;return(i<<a|i>>>32-a)+t},a._hh=function(e,t,r,n,o,a,u){var i=e+(t^r^n)+(o>>>0)+u;return(i<<a|i>>>32-a)+t},a._ii=function(e,t,r,n,o,a,u){var i=e+(r^(t|~n))+(o>>>0)+u;return(i<<a|i>>>32-a)+t},a._blocksize=16,a._digestsize=16,e.exports=function(e,r){if(void 0===e||null===e)throw new Error("Illegal argument "+e);var n=t.wordsToBytes(a(e,r));return r&&r.asBytes?n:r&&r.asString?o.bytesToString(n):t.bytesToHex(n)}}()});return{Client:Be,sign:Te,Bucket:function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;be(this,e),this.bucketName=t,this.operatorName=r,this.password=Pe(n)}}});